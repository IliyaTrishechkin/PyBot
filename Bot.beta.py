import os
import json
import logging
from pathlib import Path
from dotenv import load_dotenv
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, ContextTypes, CommandHandler, CallbackQueryHandler, ConversationHandler, MessageHandler, filters

load_dotenv(Path(__file__).parent / '.env', encoding='utf-8-sig')
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
ADMIN_ID = int(os.getenv("ADMIN_IDENT"))

STATE_ASK, STATE_FB, STATE_REV = range(1, 4)
DATA = json.loads((Path(__file__).parent / 'question.json').read_text(encoding='utf-8'))
SYMBOL = DATA["SYMBOL"]

async def start_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [
        [InlineKeyboardButton("‚ùì –ß–∞—Å—Ç—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è", callback_data="menu_faq"),
         InlineKeyboardButton("üåü –ü—Ä–æ Star for Life Ukraine", callback_data="menu_about")],
        [InlineKeyboardButton("‚úâÔ∏è –ó–∞–¥–∞—Ç–∏ —Å–≤–æ—î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è", callback_data="menu_ask"),
         InlineKeyboardButton("üì± –°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ", callback_data="menu_social")],
        [InlineKeyboardButton("üí¨ –ó–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫", callback_data="menu_feedback"),
         InlineKeyboardButton("üíª –ö—É—Ä—Å–∏", callback_data="menu_courses")],
        [InlineKeyboardButton("‚≠êÔ∏è –í—ñ–¥–≥—É–∫–∏", callback_data="menu_reviews")]
    ]
    await update.message.reply_text(DATA["Hello"], reply_markup=InlineKeyboardMarkup(kb))
    with open('id_users.json', 'r', encoding='utf-8') as f:
        ud = json.load(f)
    users = ud.get("Id_users", [])
    uid = str(update.effective_user.id)
    if uid not in users:
        users.append(uid)
        ud["Id_users"] = users
        with open('id_users.json', 'w', encoding='utf-8') as f:
            json.dump(ud, f, ensure_ascii=False, indent=4)

async def on_main_menu_pressed(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    match q.data:
        case "menu_faq":
            kb = [
                [InlineKeyboardButton("–í—ñ–¥ –¥–∏—Ç–∏–Ω–∏", callback_data="faq|child")],
                [InlineKeyboardButton("–í—ñ–¥ –¥–æ—Ä–æ—Å–ª–æ–≥–æ", callback_data="faq|adult")],
                [InlineKeyboardButton("‚Üê –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="menu_main")]
            ]
            await q.edit_message_text("–í—ñ–¥ –∫–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è?", reply_markup=InlineKeyboardMarkup(kb))
        case "menu_about":
            txt = DATA["SchoolInfo"]["text"]
            kb = [
                [InlineKeyboardButton("–î—ñ–∑–Ω–∞—Ç–∏—Å—è –±—ñ–ª—å—à–µ", url=DATA["SchoolInfo"]["url"])],
                [InlineKeyboardButton("‚Üê –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="menu_main")]
            ]
            await q.edit_message_text(txt, reply_markup=InlineKeyboardMarkup(kb))
        case "menu_ask":
            await q.edit_message_text("–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è, —ñ —è –ø–µ—Ä–µ–¥–∞–º –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
            return STATE_ASK
        case "menu_feedback":
            await q.edit_message_text("–ù–∞–¥—ñ—à–ª—ñ—Ç—å –≤–∞—à –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫:")
            return STATE_FB
        case "menu_reviews":
            await q.edit_message_text("–ó–∞–ª–∏—à—Ç–µ –≤—ñ–¥–≥—É–∫ –ø—Ä–æ –∫—É—Ä—Å —á–∏ –±–æ—Ç–∞:")
            return STATE_REV
        case "menu_social":
            kb = [[InlineKeyboardButton(n, url=u)] for n, u in DATA["Social"].items()]
            kb.append([InlineKeyboardButton("‚Üê –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="menu_main")])
            await q.edit_message_text("–ù–∞—à—ñ —Å–æ—Ü–º–µ—Ä–µ–∂—ñ:", reply_markup=InlineKeyboardMarkup(kb))
        case "menu_courses":
            txt = DATA["ActiveCourse"]["Hello"]
            kb = [[InlineKeyboardButton(n, callback_data=f"course|{n}")] for n in DATA["ActiveCourse"]["Course"]]
            kb.append([InlineKeyboardButton("‚Üê –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="menu_main")])
            await q.edit_message_text(txt, reply_markup=InlineKeyboardMarkup(kb))
        case "menu_main":
            kb = [
                [InlineKeyboardButton("‚ùì –ß–∞—Å—Ç—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è", callback_data="menu_faq"),
                 InlineKeyboardButton("üåü –ü—Ä–æ Star for Life Ukraine", callback_data="menu_about")],
                [InlineKeyboardButton("‚úâÔ∏è –ó–∞–¥–∞—Ç–∏ —Å–≤–æ—î –∑–∞–ø–∏—Ç–∞–Ω–Ω—è", callback_data="menu_ask"),
                 InlineKeyboardButton("üì± –°–æ—Ü—ñ–∞–ª—å–Ω—ñ –º–µ—Ä–µ–∂—ñ", callback_data="menu_social")],
                [InlineKeyboardButton("üí¨ –ó–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫", callback_data="menu_feedback"),
                 InlineKeyboardButton("üíª –ö—É—Ä—Å–∏", callback_data="menu_courses")],
                [InlineKeyboardButton("‚≠êÔ∏è –í—ñ–¥–≥—É–∫–∏", callback_data="menu_reviews")]
            ]
            await q.edit_message_text(DATA["Hello"], reply_markup=InlineKeyboardMarkup(kb))

async def receive_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    u = update.effective_user
    context.bot_data['last_user'] = u.id
    msg = f"–ù–æ–≤–µ –ø–∏—Ç–∞–Ω–Ω—è –≤—ñ–¥ @{u.username or '–Ω–µ–≤—ñ–¥–æ–º–∏–π'} (ID: {u.id}):\n\n{update.message.text}"
    await context.bot.send_message(ADMIN_ID, msg)
    await update.message.reply_text("–î—è–∫—É—é! –ü–∏—Ç–∞–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É.")
    return ConversationHandler.END

async def receive_feedback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    u = update.effective_user
    msg = f"–ó–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫ –≤—ñ–¥ @{u.username or '–Ω–µ–≤—ñ–¥–æ–º–∏–π'} (ID: {u.id}):\n\n{update.message.text}"
    await context.bot.send_message(ADMIN_ID, msg)
    await update.message.reply_text("–î—è–∫—É—é –∑–∞ –≤–∞—à –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π –∑–≤'—è–∑–æ–∫!")
    return ConversationHandler.END

async def receive_review(update: Update, context: ContextTypes.DEFAULT_TYPE):
    u = update.effective_user
    msg = f"–í—ñ–¥–≥—É–∫ –≤—ñ–¥ @{u.username or '–Ω–µ–≤—ñ–¥–æ–º–∏–π'} (ID: {u.id}):\n\n{update.message.text}"
    await context.bot.send_message(ADMIN_ID, msg)
    await update.message.reply_text("–î—è–∫—É—é –∑–∞ –≤–∞—à –≤—ñ–¥–≥—É–∫!")
    return ConversationHandler.END

async def HelpAdmin(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.id != ADMIN_ID:
        return
    await update.message.reply_text(f"üîπ/sb –∑–º—ñ–Ω–∏—Ç–∏ —Å–∏–º–≤–æ–ª (–∑–∞—Ä–∞–∑ {SYMBOL})\nüîπ/ad —Ä–æ–∑—Å–∏–ª–∫–∞ (/ad —Ç–µ–∫—Å—Ç{SYMBOL}–ø–æ—Å–∏–ª–∞–Ω–Ω—è)\nüîπ/add –¥–æ–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è (/add child{SYMBOL}–ø–∏—Ç–∞–Ω–Ω—è{SYMBOL}–≤—ñ–¥–ø–æ–≤—ñ–¥—å)\nüîπ–í—ñ–¥–ø–æ–≤—ñ–¥—ñ: id{SYMBOL}—Ç–µ–∫—Å—Ç –∞–±–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç")

async def set_symbol(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.id != ADMIN_ID:
        await update.message.reply_text("–¢—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω.")
        return
    d = json.loads((Path(__file__).parent / 'question.json').read_text(encoding='utf-8'))
    sym = (update.message.text or "").replace("/sb", "").strip()
    if len(sym) != 1:
        await update.message.reply_text("–í–∫–∞–∂—ñ—Ç—å –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª.")
        return
    d["SYMBOL"] = sym
    with open(Path(__file__).parent / 'question.json', 'w', encoding='utf-8') as f:
        json.dump(d, f, ensure_ascii=False, indent=4)
    await update.message.reply_text(f"–°–∏–º–≤–æ–ª –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ {sym}")

async def add_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.type != "private":
        if not context.args:
            return
        msg = " ".join(context.args)
        parts = msg.split(SYMBOL)
        if len(parts) != 3:
            return
        grp, qt, ans = parts[0].strip(), parts[1].strip(), parts[2].strip()
        if grp in ["child", "adult"] and qt not in DATA["FAQs"][grp]:
            DATA["FAQs"][grp][qt] = ans
            with open(Path(__file__).parent / 'question.json', 'w', encoding='utf-8') as f:
                json.dump(DATA, f, ensure_ascii=False, indent=4)

async def ad(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.id != ADMIN_ID:
        return
    ex = no = 0
    ids = json.loads((Path(__file__).parent / 'id_users.json').read_text(encoding='utf-8'))["Id_users"]
    if update.message.photo:
        photo = update.message.photo[-1].file_id
        cap = (update.message.caption or "").replace("/ad", "").strip().split(SYMBOL)
        body, kb = (cap[0], [[InlineKeyboardButton("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è", url=cap[1])]]) if len(cap) == 2 else ("", [])
        for uid in ids:
            try:
                if body:
                    await context.bot.send_photo(int(uid), photo=photo, caption=body, reply_markup=InlineKeyboardMarkup(kb))
                else:
                    await context.bot.send_photo(int(uid), photo=photo)
                ex += 1
            except:
                no += 1
    else:
        txt = (update.message.text or "").replace("/ad", "").strip().split(SYMBOL)
        body, kb = ("".join(txt[:-1]), [[InlineKeyboardButton("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è", url=txt[-1])]]) if len(txt) > 1 else (txt[0], [])
        for uid in ids:
            try:
                await context.bot.send_message(int(uid), text=body, reply_markup=InlineKeyboardMarkup(kb))
                ex += 1
            except:
                no += 1
    await update.message.reply_text(f"‚úÖ –£—Å–ø—ñ—à–Ω–æ: {ex}\n‚ùå –ü–æ–º–∏–ª–∫–∏: {no}")

async def ClikButton(update: Update, context: ContextTypes.DEFAULT_TYPE):
    q = update.callback_query
    await q.answer()
    parts = q.data.split("|")
    cmd, arg = parts[0], parts[-1]
    if cmd == "faq":
        qs = list(DATA["FAQs"][arg].keys())
        kb = [[InlineKeyboardButton(q, callback_data=f"showfaq|{arg}|{i}")] for i, q in enumerate(qs)]
        kb.append([InlineKeyboardButton("‚Üê –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="menu_main")])
        await q.edit_message_text("–û–±–µ—Ä—ñ—Ç—å –∑–∞–ø–∏—Ç–∞–Ω–Ω—è:", reply_markup=InlineKeyboardMarkup(kb))
    elif cmd == "course":
        txt, url = DATA["ActiveCourse"]["Course"][arg]
        kb = [[InlineKeyboardButton("–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è", url=url)], [InlineKeyboardButton("‚Üê –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="menu_main")]]
        await q.edit_message_text(txt, reply_markup=InlineKeyboardMarkup(kb))
    elif cmd == "showfaq":
        grp, idx = parts[1], int(parts[2])
        key = list(DATA["FAQs"][grp].keys())[idx]
        ans = DATA["FAQs"][grp][key]
        txt = f"‚ùì {key}\n\nüí¨ {ans}"
        kb = [[InlineKeyboardButton("‚Üê –ù–∞–∑–∞–¥", callback_data=f"faq|{grp}")]]
        await q.edit_message_text(txt, reply_markup=InlineKeyboardMarkup(kb))
    elif cmd == "myQ":
        await q.message.reply_text("–ù–∞–ø–∏—à—ñ—Ç—å —Å–≤–æ—î –ø–∏—Ç–∞–Ω–Ω—è.")
        return STATE_ASK

async def admin_reply(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_chat.id != ADMIN_ID:
        return
    parts = update.message.text.split(SYMBOL)
    if len(parts) == 1:
        uid = context.bot_data.pop('last_user', None)
        if uid:
            await context.bot.send_message(uid, f"–í—ñ–¥–ø–æ–≤—ñ–¥—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n\n{parts[0]}")
    else:
        uid = int(parts[0])
        await context.bot.send_message(uid, f"–í—ñ–¥–ø–æ–≤—ñ–¥—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:\n\n{parts[1]}")

if __name__ == "__main__":
    logging.basicConfig(level=logging.INFO)
    app = ApplicationBuilder().token(TOKEN).build()

    conv_ask = ConversationHandler(
        entry_points=[CallbackQueryHandler(on_main_menu_pressed, pattern="^menu_ask$")],
        states={STATE_ASK: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_question)]},
        fallbacks=[]
    )
    conv_fb = ConversationHandler(
        entry_points=[CallbackQueryHandler(on_main_menu_pressed, pattern="^menu_feedback$")],
        states={STATE_FB: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_feedback)]},
        fallbacks=[]
    )
    conv_rev = ConversationHandler(
        entry_points=[CallbackQueryHandler(on_main_menu_pressed, pattern="^menu_reviews$")],
        states={STATE_REV: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_review)]},
        fallbacks=[]
    )

    app.add_handler(conv_ask)
    app.add_handler(conv_fb)
    app.add_handler(conv_rev)
    app.add_handler(CommandHandler("start", start_cmd))
    app.add_handler(CommandHandler("help", HelpAdmin))
    app.add_handler(CommandHandler("sb", set_symbol))
    app.add_handler(CommandHandler("add", add_question))
    app.add_handler(MessageHandler((filters.Regex(r"^/ad") | filters.CaptionRegex(r"^/ad")) & filters.Chat(ADMIN_ID), ad))
    app.add_handler(CallbackQueryHandler(on_main_menu_pressed, pattern="^menu_"))
    app.add_handler(CallbackQueryHandler(ClikButton, pattern="^(faq|course|showfaq|myQ)\|"))
    app.add_handler(MessageHandler(filters.Chat(ADMIN_ID) & filters.TEXT, admin_reply))

    app.run_polling(drop_pending_updates=True)

#YaroBot